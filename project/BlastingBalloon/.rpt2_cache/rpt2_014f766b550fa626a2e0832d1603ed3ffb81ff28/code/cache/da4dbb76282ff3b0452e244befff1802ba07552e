{
  "code": "export var WXDataManager;\r\n(function (WXDataManager) {\r\n    WXDataManager._gameData = {\r\n        _levels: 1,\r\n        _propNum: 5,\r\n    };\r\n    WXDataManager.wx = Laya.Browser.window.wx;\r\n    function WXcheckSession() {\r\n        if (Laya.Browser.onMiniGame) {\r\n            WXDataManager.wx.checkSession({\r\n                success() {\r\n                    console.log('已经登录过了！');\r\n                },\r\n                fail() {\r\n                    authorizedWXLogin();\r\n                    console.log('重新登录');\r\n                }\r\n            });\r\n        }\r\n    }\r\n    WXDataManager.WXcheckSession = WXcheckSession;\r\n    function authorizedWXLogin() {\r\n        if (Laya.Browser.onMiniGame) {\r\n            WXDataManager.wx.login({\r\n                success: function (res) {\r\n                    if (res.code) {\r\n                        console.log(\"登录成功，获取到code\", res.code);\r\n                    }\r\n                    var button = WXDataManager.wx.createUserInfoButton({\r\n                        type: 'text',\r\n                        text: '开始游戏',\r\n                        style: {\r\n                            left: WXDataManager.wx.getSystemInfoSync().screenWidth / 2 - 60,\r\n                            bottom: WXDataManager.wx.getSystemInfoSync().screenHeight / 2 - 60,\r\n                            width: 120,\r\n                            height: 40,\r\n                            lineHeight: 40,\r\n                            backgroundColor: '#fb94a9',\r\n                            color: '#ffffff',\r\n                            textAlign: 'center',\r\n                            fontSize: 16,\r\n                            borderRadius: 20\r\n                        }\r\n                    });\r\n                    button.show();\r\n                    button.onTap((res) => {\r\n                        console.log(res);\r\n                        if (res.errMsg === \"getUserInfo:ok\") {\r\n                            console.log(\"已经授权\");\r\n                            button.destroy();\r\n                            getUserinfo(null);\r\n                        }\r\n                        else {\r\n                            console.log(\"没有授权\");\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    }\r\n    WXDataManager.authorizedWXLogin = authorizedWXLogin;\r\n    function normalWXLogin() {\r\n        if (Laya.Browser.onMiniGame) {\r\n            WXDataManager.wx.checkSession({\r\n                success() {\r\n                    console.log('已经登录过了！');\r\n                    getUserinfo('haveLogin');\r\n                },\r\n                fail() {\r\n                    console.log('重新登录');\r\n                    WXDataManager.wx.login({\r\n                        success(res) {\r\n                            getUserinfo('firstlogin');\r\n                        },\r\n                        fail() {\r\n                            console.log('登录失败');\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            console.log(\"登陆仅支持微信客户端\");\r\n        }\r\n    }\r\n    WXDataManager.normalWXLogin = normalWXLogin;\r\n    function getUserinfo(type) {\r\n        if (Laya.Browser.onMiniGame) {\r\n            WXDataManager.wx.cloud.init({\r\n                env: 'release-lwg'\r\n            });\r\n            WXDataManager.wx.cloud.callFunction({\r\n                name: \"login\",\r\n            }).then(res => {\r\n                console.log(\"登录成功回调：\", res);\r\n                WXDataManager.WXopenid = res.result.openid;\r\n                console.log(\"WXopenid为：\", WXDataManager.WXopenid);\r\n                WXDataManager.user_id = WXDataManager.WXopenid;\r\n                if (type === 'firstlogin') {\r\n                    try {\r\n                        add_GameData();\r\n                    }\r\n                    catch (error) {\r\n                        console.log(error);\r\n                    }\r\n                    try {\r\n                        get_GameData();\r\n                    }\r\n                    catch (error) {\r\n                        console.log(error);\r\n                    }\r\n                }\r\n                else if (type === 'haveLogin') {\r\n                    try {\r\n                        get_GameData();\r\n                    }\r\n                    catch (error) {\r\n                        console.log(error);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            console.log(\"获取玩家信息仅支持微信客户端\");\r\n        }\r\n    }\r\n    WXDataManager.getUserinfo = getUserinfo;\r\n    function add_GameData() {\r\n        if (Laya.Browser.onMiniGame) {\r\n            WXDataManager.wx.cloud.init({\r\n                env: 'release-lwg'\r\n            });\r\n            let db = WXDataManager.wx.cloud.database();\r\n            let user_info = db.collection('user_info');\r\n            user_info.add({\r\n                data: {\r\n                    _id: WXDataManager.user_id,\r\n                    gameData: WXDataManager._gameData,\r\n                    due: new Date(\"2018-09-01\"),\r\n                    location: new db.Geo.Point(113, 23),\r\n                    done: false\r\n                },\r\n            }).then(res => {\r\n                console.log('没有登录过重新上传：' + res);\r\n            });\r\n        }\r\n        else {\r\n            console.log(\"添加信息仅支持微信客户端\");\r\n        }\r\n    }\r\n    WXDataManager.add_GameData = add_GameData;\r\n    function get_GameData() {\r\n        if (Laya.Browser.onMiniGame) {\r\n            WXDataManager.wx.cloud.init({\r\n                env: 'release-lwg'\r\n            });\r\n            let db = WXDataManager.wx.cloud.database();\r\n            let user_info = db.collection('user_info');\r\n            user_info.doc(WXDataManager.user_id).get().then(res => {\r\n                console.log(res.data);\r\n                WXDataManager._gameData = res.data.gameData;\r\n                WXDataManager._gameData = res.data.gameData;\r\n                console.log('上次的关卡数为：' + WXDataManager._gameData._levels, '上次的道具数为：' + WXDataManager._gameData._propNum);\r\n            });\r\n        }\r\n        else {\r\n            console.log(\"获取信息仅支持微信客户端\");\r\n        }\r\n    }\r\n    WXDataManager.get_GameData = get_GameData;\r\n    function update_GameData() {\r\n        try {\r\n        }\r\n        catch (error) {\r\n        }\r\n        if (Laya.Browser.onMiniGame) {\r\n            WXDataManager.wx.cloud.init({\r\n                env: 'release-lwg'\r\n            });\r\n            let db = WXDataManager.wx.cloud.database();\r\n            let user_info = db.collection('user_info');\r\n            user_info.doc(WXDataManager.user_id).update({\r\n                data: {\r\n                    gameData: WXDataManager._gameData,\r\n                },\r\n            }).then(res => {\r\n                console.log(res);\r\n            });\r\n        }\r\n        else {\r\n            console.log(\"上传信息仅支持微信客户端\");\r\n        }\r\n    }\r\n    WXDataManager.update_GameData = update_GameData;\r\n    function wxPostInit() {\r\n        if (Laya.Browser.onMiniGame) {\r\n            Laya.loader.load([\"res/atlas/rank.atlas\"], Laya.Handler.create(null, function () {\r\n                Laya.MiniAdpter.sendAtlasToOpenDataContext(\"res/atlas/rank.atlas\");\r\n                let wx = Laya.Browser.window.wx;\r\n                let openDataContext = wx.getOpenDataContext();\r\n                openDataContext.postMessage({ action: 'init' });\r\n            }));\r\n        }\r\n    }\r\n    WXDataManager.wxPostInit = wxPostInit;\r\n    function wxPostData(score) {\r\n        if (Laya.Browser.onMiniGame) {\r\n            let args = {\r\n                type: 'scores', data: { scores: score }\r\n            };\r\n            let wx = Laya.Browser.window.wx;\r\n            let openDataContext = wx.getOpenDataContext();\r\n            openDataContext.postMessage(args);\r\n            console.log('上传了');\r\n        }\r\n        else {\r\n            console.log('没有上传');\r\n        }\r\n    }\r\n    WXDataManager.wxPostData = wxPostData;\r\n    function wxShare() {\r\n        if (Laya.Browser.onMiniGame) {\r\n            let wx = Laya.Browser.window.wx;\r\n            wx.shareAppMessage({\r\n                title: '你的手速够快吗？',\r\n                imageUrlId: 'CRYATpcgSFGkeB4Hs75jOQ',\r\n                imageUrl: 'https://mmocgame.qpic.cn/wechatgame/9zdKibmXJ3RsmFpXn6UAV4ScT8ulA4wzqUUNicKWDIaODZbuv38lkBBOBQv8XbxOI0/0'\r\n            });\r\n            console.log(\"主动进行了转发\");\r\n        }\r\n        else {\r\n            console.log(\"仅支持微信客户端\");\r\n        }\r\n    }\r\n    WXDataManager.wxShare = wxShare;\r\n})(WXDataManager || (WXDataManager = {}));\r\nexport default WXDataManager;\r\n",
  "references": []
}
